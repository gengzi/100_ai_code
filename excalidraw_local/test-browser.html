<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excalidraw æ¸²æŸ“æµ‹è¯•</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1, h2 {
            color: #333;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .image-container {
            text-align: center;
            margin: 20px 0;
            padding: 20px;
            border: 2px dashed #ddd;
            border-radius: 8px;
            background-color: #fafafa;
        }
        .rendered-image {
            max-width: 100%;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .loading {
            color: #007bff;
            font-style: italic;
        }
        .json-preview {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin: 10px 0;
        }
        .test-data-selector {
            margin: 10px 0;
        }
        select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            margin: 0 10px;
        }
    </style>
</head>
<body>
    <!-- React å’Œ ReactDOM åº“æ–‡ä»¶ - ä½¿ç”¨ç»å¯¹è·¯å¾„ -->
    <script src="./react.production.min.js"></script>
    <script src="./react-dom.production.min.js"></script>
    <script src="./excalidraw.production.min.js"></script>

    <!-- æ£€æŸ¥åº“åŠ è½½çŠ¶æ€ -->
    <script>
        // ç­‰å¾…æ‰€æœ‰è„šæœ¬åŠ è½½å®Œæˆ
        setTimeout(function() {
            console.log('=== æ£€æŸ¥åº“åŠ è½½çŠ¶æ€ ===');
            console.log('React loaded:', typeof React !== 'undefined' ? React : 'undefined');
            console.log('ReactDOM loaded:', typeof ReactDOM !== 'undefined' ? ReactDOM : 'undefined');
            console.log('Excalidraw loaded:', typeof ExcalidrawLib !== 'undefined' ? ExcalidrawLib : 'undefined');
            console.log('window.React loaded:', typeof window.React !== 'undefined' ? window.React : 'undefined');
            console.log('window.ReactDOM loaded:', typeof window.ReactDOM !== 'undefined' ? window.ReactDOM : 'undefined');
            console.log('window.ExcalidrawLib loaded:', typeof window.ExcalidrawLib !== 'undefined' ? window.ExcalidrawLib : 'undefined');

            // æ£€æŸ¥window.ExcalidrawLibæ˜¯å¦å­˜åœ¨
            if (typeof window.ExcalidrawLib !== 'undefined') {
                console.log('ExcalidrawLib methods:', Object.keys(window.ExcalidrawLib));
            } else {
                console.error('ExcalidrawLib æœªåŠ è½½ï¼Œå¯èƒ½éœ€è¦æ£€æŸ¥åº“æ–‡ä»¶');
            }

            // æ£€æŸ¥æ–‡ä»¶å¤§å°
            fetch('react.production.min.js', { method: 'HEAD' })
                .then(response => console.log('React file size:', response.headers.get('content-length')))
                .catch(err => console.error('Cannot fetch React file size:', err));

            fetch('react-dom.production.min.js', { method: 'HEAD' })
                .then(response => console.log('ReactDOM file size:', response.headers.get('content-length')))
                .catch(err => console.error('Cannot fetch ReactDOM file size:', err));

            fetch('excalidraw.production.min.js', { method: 'HEAD' })
                .then(response => console.log('Excalidraw file size:', response.headers.get('content-length')))
                .catch(err => console.error('Cannot fetch Excalidraw file size:', err));

        }, 100);
    </script>

    <div class="container">
        <h1>ğŸ¨ Excalidraw æ¸²æŸ“æœåŠ¡æµ‹è¯•</h1>

        <div id="serverStatus" class="status info">
            æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€ä¸­...
        </div>

        <div class="test-data-selector">
            <label for="dataType">é€‰æ‹©æµ‹è¯•æ•°æ®:</label>
            <select id="dataType">
                <option value="simple">ç®€å•å›¾è¡¨</option>
                <option value="flowchart">æµç¨‹å›¾</option>
            </select>
        </div>

        <div>
            <button id="testHealthBtn" onclick="testHealth()">ğŸ¥ æµ‹è¯•å¥åº·æ£€æŸ¥</button>
            <button id="testRenderBtn" onclick="testRender()">ğŸ¯ æµ‹è¯•å›¾è¡¨æ¸²æŸ“</button>
            <button id="clearBtn" onclick="clearResult()">ğŸ—‘ï¸ æ¸…é™¤ç»“æœ</button>
        </div>
    </div>

    <div class="container">
        <h2>ğŸ“Š æ¸²æŸ“ç»“æœ</h2>
        <div id="renderResult" class="image-container">
            <p style="color: #666;">ç‚¹å‡»"æµ‹è¯•å›¾è¡¨æ¸²æŸ“"æŒ‰é’®å¼€å§‹æµ‹è¯•</p>
        </div>
    </div>

    <div class="container">
        <h2>ğŸ”§ è¯·æ±‚æ•°æ®</h2>
        <div id="requestData" class="json-preview">
            è¯·æ±‚æ•°æ®å°†åœ¨æ¸²æŸ“åæ˜¾ç¤ºåœ¨è¿™é‡Œ
        </div>
    </div>

    <script>
        const SERVER_URL = 'http://localhost:3004';

        // æµ‹è¯•æ•°æ®
        const testData = {
            simple: {
                "data": {
                    "elements": [
                        {
                            "type": "rectangle",
                            "id": "rect-1",
                            "x": 100,
                            "y": 100,
                            "width": 200,
                            "height": 100,
                            "strokeColor": "#1e40af",
                            "backgroundColor": "#dbeafe",
                            "fillStyle": "solid",
                            "strokeWidth": 2,
                            "roughness": 1,
                            "opacity": 100,
                            "seed": 12345
                        },
                        {
                            "type": "rectangle",
                            "id": "rect-2",
                            "x": 400,
                            "y": 100,
                            "width": 200,
                            "height": 100,
                            "strokeColor": "#dc2626",
                            "backgroundColor": "#fecaca",
                            "fillStyle": "solid",
                            "strokeWidth": 2,
                            "roughness": 1,
                            "opacity": 100,
                            "seed": 12346
                        },
                        {
                            "type": "text",
                            "id": "text-1",
                            "x": 150,
                            "y": 135,
                            "width": 100,
                            "height": 30,
                            "text": "æµ‹è¯•è¾“å…¥",
                            "fontSize": 20,
                            "fontFamily": 1,
                            "textAlign": "center",
                            "verticalAlign": "middle",
                            "containerId": null,
                            "originalText": "æµ‹è¯•è¾“å…¥",
                            "baseline": 21,
                            "strokeColor": "#1e40af",
                            "backgroundColor": "transparent"
                        },
                        {
                            "type": "text",
                            "id": "text-2",
                            "x": 450,
                            "y": 135,
                            "width": 100,
                            "height": 30,
                            "text": "æµ‹è¯•è¾“å‡º",
                            "fontSize": 20,
                            "fontFamily": 1,
                            "textAlign": "center",
                            "verticalAlign": "middle",
                            "containerId": null,
                            "originalText": "æµ‹è¯•è¾“å‡º",
                            "baseline": 21,
                            "strokeColor": "#dc2626",
                            "backgroundColor": "transparent"
                        },
                        {
                            "type": "arrow",
                            "id": "arrow-1",
                            "x": 300,
                            "y": 150,
                            "width": 100,
                            "height": 0,
                            "points": [[0, 0], [100, 0]],
                            "strokeColor": "#374151",
                            "strokeWidth": 2,
                            "roughness": 1,
                            "opacity": 100,
                            "startArrowhead": null,
                            "endArrowhead": "arrow",
                            "seed": 12348
                        }
                    ],
                    "appState": {
                        "viewBackgroundColor": "#ffffff",
                        "currentItemStrokeColor": "#000000",
                        "currentItemBackgroundColor": "transparent",
                        "zoom": { "value": 1 },
                        "scrollX": 0,
                        "scrollY": 0
                    },
                    "files": {}
                }
            },
            flowchart: {
                "data": {
                    "elements": [
                        {
                            "type": "rectangle",
                            "id": "start",
                            "x": 50,
                            "y": 50,
                            "width": 160,
                            "height": 60,
                            "strokeColor": "#16a34a",
                            "backgroundColor": "#bbf7d0",
                            "fillStyle": "solid",
                            "strokeWidth": 2,
                            "roughness": 1,
                            "opacity": 100,
                            "seed": 1001,
                            "roundness": { "type": 3, "value": 16 }
                        },
                        {
                            "type": "text",
                            "id": "start-text",
                            "x": 110,
                            "y": 65,
                            "width": 40,
                            "height": 30,
                            "text": "å¼€å§‹",
                            "fontSize": 20,
                            "fontFamily": 1,
                            "textAlign": "center",
                            "verticalAlign": "middle",
                            "containerId": null,
                            "originalText": "å¼€å§‹",
                            "baseline": 21,
                            "strokeColor": "#16a34a",
                            "backgroundColor": "transparent"
                        },
                        {
                            "type": "rectangle",
                            "id": "process1",
                            "x": 50,
                            "y": 170,
                            "width": 160,
                            "height": 80,
                            "strokeColor": "#2563eb",
                            "backgroundColor": "#bfdbfe",
                            "fillStyle": "solid",
                            "strokeWidth": 2,
                            "roughness": 1,
                            "opacity": 100,
                            "seed": 1002
                        },
                        {
                            "type": "text",
                            "id": "process1-text",
                            "x": 60,
                            "y": 185,
                            "width": 140,
                            "height": 50,
                            "text": "æ•°æ®å¤„ç†",
                            "fontSize": 16,
                            "fontFamily": 1,
                            "textAlign": "center",
                            "verticalAlign": "middle",
                            "containerId": null,
                            "originalText": "æ•°æ®å¤„ç†",
                            "baseline": 21,
                            "strokeColor": "#2563eb",
                            "backgroundColor": "transparent"
                        },
                        {
                            "type": "arrow",
                            "id": "arrow1",
                            "x": 130,
                            "y": 110,
                            "width": 0,
                            "height": 60,
                            "points": [[0, 0], [0, 60]],
                            "strokeColor": "#374151",
                            "strokeWidth": 2,
                            "roughness": 1,
                            "opacity": 100,
                            "startArrowhead": null,
                            "endArrowhead": "arrow",
                            "seed": 2001
                        }
                    ],
                    "appState": {
                        "viewBackgroundColor": "#f8fafc",
                        "currentItemStrokeColor": "#000000",
                        "currentItemBackgroundColor": "transparent",
                        "zoom": { "value": 1 },
                        "scrollX": 0,
                        "scrollY": 0
                    },
                    "files": {}
                }
            }
        };

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€
        window.onload = function() {
            testHealth();
        };

        // æµ‹è¯•å¥åº·æ£€æŸ¥
        async function testHealth() {
            const statusEl = document.getElementById('serverStatus');
            const btn = document.getElementById('testHealthBtn');

            btn.disabled = true;
            statusEl.className = 'status info';
            statusEl.textContent = 'æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€ä¸­...';

            try {
                const response = await fetch(`${SERVER_URL}/health`);
                const result = await response.json();

                if (response.ok) {
                    statusEl.className = 'status success';
                    statusEl.innerHTML = `âœ… æœåŠ¡å™¨è¿è¡Œæ­£å¸¸<br>
                    çŠ¶æ€: ${result.status}<br>
                    ç‰ˆæœ¬: ${result.version}<br>
                    è¿è¡Œæ—¶é—´: ${Math.floor(result.uptime)}ç§’`;
                } else {
                    throw new Error(result.message || 'å¥åº·æ£€æŸ¥å¤±è´¥');
                }
            } catch (error) {
                statusEl.className = 'status error';
                statusEl.innerHTML = `âŒ æœåŠ¡å™¨è¿æ¥å¤±è´¥<br>é”™è¯¯: ${error.message}<br>
                è¯·ç¡®ä¿æœåŠ¡å™¨åœ¨ ${SERVER_URL} è¿è¡Œ`;
            } finally {
                btn.disabled = false;
            }
        }

        // æµ‹è¯•æ¸²æŸ“
        async function testRender() {
            const resultEl = document.getElementById('renderResult');
            const dataEl = document.getElementById('requestData');
            const btn = document.getElementById('testRenderBtn');
            const dataType = document.getElementById('dataType').value;
            const requestData = testData[dataType];

            btn.disabled = true;
            resultEl.innerHTML = '<p class="loading">ğŸ”„ æ­£åœ¨æ¸²æŸ“å›¾è¡¨ï¼Œè¯·ç¨å€™...</p>';
            dataEl.textContent = 'è¯·æ±‚æ•°æ®å°†åœ¨æ¸²æŸ“åæ˜¾ç¤ºåœ¨è¿™é‡Œ';

            try {
                // æ˜¾ç¤ºè¯·æ±‚æ•°æ®
                dataEl.textContent = JSON.stringify(requestData, null, 2);

                // å‘é€æ¸²æŸ“è¯·æ±‚
                const response = await fetch(`${SERVER_URL}/render`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });

                if (response.ok) {
                    // è·å–å›¾ç‰‡æ•°æ®
                    const imageBlob = await response.blob();
                    const imageUrl = URL.createObjectURL(imageBlob);

                    // æ˜¾ç¤ºæ¸²æŸ“ç»“æœ
                    resultEl.innerHTML = `
                        <h3 style="color: #28a745; margin-top: 0;">âœ… æ¸²æŸ“æˆåŠŸï¼</h3>
                        <p>æ¸²æŸ“æ—¶é—´: ${response.headers.get('X-Render-Time')}ms</p>
                        <p>å…ƒç´ æ•°é‡: ${response.headers.get('X-Elements-Count')}</p>
                        <img src="${imageUrl}" alt="æ¸²æŸ“çš„å›¾è¡¨" class="rendered-image" />
                        <br>
                        <a href="${imageUrl}" download="excalidraw-render-${Date.now()}.png"
                           style="display: inline-block; margin-top: 10px; color: #007bff; text-decoration: none;">
                            ğŸ’¾ ä¸‹è½½å›¾ç‰‡
                        </a>
                    `;
                } else {
                    const error = await response.json();
                    throw new Error(error.message || error.error || 'æ¸²æŸ“å¤±è´¥');
                }
            } catch (error) {
                resultEl.innerHTML = `
                    <div class="error" style="margin: 0;">
                        âŒ æ¸²æŸ“å¤±è´¥<br>
                        é”™è¯¯ä¿¡æ¯: ${error.message}
                    </div>
                `;
            } finally {
                btn.disabled = false;
            }
        }

        // æ¸…é™¤ç»“æœ
        function clearResult() {
            document.getElementById('renderResult').innerHTML =
                '<p style="color: #666;">ç‚¹å‡»"æµ‹è¯•å›¾è¡¨æ¸²æŸ“"æŒ‰é’®å¼€å§‹æµ‹è¯•</p>';
            document.getElementById('requestData').textContent =
                'è¯·æ±‚æ•°æ®å°†åœ¨æ¸²æŸ“åæ˜¾ç¤ºåœ¨è¿™é‡Œ';
        }
    </script>
</body>
</html>