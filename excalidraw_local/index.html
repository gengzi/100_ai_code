<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excalidraw æœ¬åœ°æ¸²æŸ“</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
        }

        .header {
            background: white;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #333;
            margin-bottom: 10px;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin: 20px;
        }

        .controls button {
            padding: 10px 20px;
            background: #4f46e5;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .controls button:hover {
            background: #4338ca;
        }

        .controls button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .main-container {
            display: flex;
            gap: 20px;
            padding: 0 20px 20px;
        }

        .canvas-container {
            flex: 1;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .excalidraw-container {
            width: 100%;
            height: 600px;
            position: relative;
        }

        .sidebar {
            width: 300px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 20px;
        }

        .sidebar h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .template-selector {
            margin-bottom: 20px;
        }

        .template-selector select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .json-editor {
            width: 100%;
            height: 300px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            resize: vertical;
        }

        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 20px;
        }

        .status.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }

        .status.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ¨ Excalidraw æœ¬åœ°æ¸²æŸ“å·¥å…·</h1>
        <p>ä½¿ç”¨æœ¬åœ°JavaScriptæ–‡ä»¶æ¸²æŸ“Excalidrawå›¾è¡¨</p>
    </div>

    <div id="status" class="status" style="display: none;"></div>

    <div class="controls">
        <button onclick="loadTemplate('simple')">åŠ è½½ç®€å•ç¤ºä¾‹</button>
        <button onclick="loadTemplate('flowchart')">åŠ è½½æµç¨‹å›¾</button>
        <button onclick="renderExcalidraw()">æ¸²æŸ“å›¾è¡¨</button>
        <button onclick="exportAsPNG()">å¯¼å‡ºä¸ºPNG</button>
        <button onclick="clearCanvas()">æ¸…ç©ºç”»å¸ƒ</button>
    </div>

    <div class="main-container">
        <div class="canvas-container">
            <div class="excalidraw-container" id="excalidraw">
                <div class="loading">
                    <p>æ­£åœ¨åŠ è½½ Excalidraw...</p>
                    <p id="loading-info">åˆå§‹åŒ–ä¸­...</p>
                </div>
            </div>
        </div>

        <div class="sidebar">
            <h3>ğŸ“ å›¾è¡¨é…ç½®</h3>

            <div class="template-selector">
                <label for="templateSelect">é€‰æ‹©æ¨¡æ¿:</label>
                <select id="templateSelect" onchange="loadTemplate(this.value)">
                    <option value="">è‡ªå®šä¹‰</option>
                    <option value="simple">ç®€å•å›¾å½¢</option>
                    <option value="flowchart">æµç¨‹å›¾</option>
                    <option value="mindmap">æ€ç»´å¯¼å›¾</option>
                </select>
            </div>

            <div>
                <label for="jsonInput">JSON æ•°æ®:</label>
                <textarea id="jsonInput" class="json-editor" placeholder="è¾“å…¥æˆ–ç²˜è´´ Excalidraw JSON æ•°æ®..."></textarea>
            </div>
        </div>
    </div>

    <!-- åŠ è½½æœ¬åœ° JavaScript æ–‡ä»¶ -->
    <script src="react.production.min.js"></script>
    <script src="react-dom.production.min.js"></script>
    <script src="excalidraw.production.min.js"></script>

    <!-- ä¸»è¦åº”ç”¨é€»è¾‘ -->
    <script>
        // å…¨å±€å˜é‡
        let excalidrawApp = null;
        let currentData = null;

        // é¢„å®šä¹‰çš„æ¨¡æ¿æ•°æ®
        const templates = {
            simple: {
                elements: [
                    {
                        id: "rect-1",
                        type: "rectangle",
                        x: 100,
                        y: 100,
                        width: 200,
                        height: 100,
                        angle: 0,
                        strokeColor: "#1e40af",
                        backgroundColor: "#dbeafe",
                        fillStyle: "solid",
                        strokeWidth: 2,
                        strokeStyle: "solid",
                        roughness: 1,
                        opacity: 100,
                        groupIds: [],
                        seed: 12345,
                        frameId: null,
                        roundness: null,
                        boundElements: null,
                        updated: 1,
                        link: null,
                        locked: false
                    },
                    {
                        id: "rect-2",
                        type: "rectangle",
                        x: 400,
                        y: 100,
                        width: 200,
                        height: 100,
                        angle: 0,
                        strokeColor: "#dc2626",
                        backgroundColor: "#fecaca",
                        fillStyle: "solid",
                        strokeWidth: 2,
                        strokeStyle: "solid",
                        roughness: 1,
                        opacity: 100,
                        groupIds: [],
                        seed: 12346,
                        frameId: null,
                        roundness: null,
                        boundElements: null,
                        updated: 1,
                        link: null,
                        locked: false
                    },
                    {
                        id: "text-1",
                        type: "text",
                        x: 200,
                        y: 135,
                        width: 100,
                        height: 30,
                        angle: 0,
                        strokeColor: "#1e40af",
                        backgroundColor: "transparent",
                        fillStyle: "solid",
                        strokeWidth: 2,
                        strokeStyle: "solid",
                        roughness: 1,
                        opacity: 100,
                        groupIds: [],
                        seed: 54123,
                        frameId: null,
                        roundness: null,
                        boundElements: null,
                        updated: 1,
                        link: null,
                        locked: false,
                        text: "è¾“å…¥æ•°æ®",
                        fontSize: 20,
                        fontFamily: 1,
                        textAlign: "center",
                        verticalAlign: "middle",
                        containerId: null,
                        originalText: "è¾“å…¥æ•°æ®",
                        lineHeight: 1.25
                    },
                    {
                        id: "text-2",
                        type: "text",
                        x: 500,
                        y: 135,
                        width: 100,
                        height: 30,
                        angle: 0,
                        strokeColor: "#dc2626",
                        backgroundColor: "transparent",
                        fillStyle: "solid",
                        strokeWidth: 2,
                        strokeStyle: "solid",
                        roughness: 1,
                        opacity: 100,
                        groupIds: [],
                        seed: 45123,
                        frameId: null,
                        roundness: null,
                        boundElements: null,
                        updated: 1,
                        link: null,
                        locked: false,
                        text: "è¾“å‡ºç»“æœ",
                        fontSize: 20,
                        fontFamily: 1,
                        textAlign: "center",
                        verticalAlign: "middle",
                        containerId: null,
                        originalText: "è¾“å‡ºç»“æœ",
                        lineHeight: 1.25
                    },
                    {
                        id: "arrow-1",
                        type: "arrow",
                        x: 300,
                        y: 150,
                        width: 100,
                        height: 0,
                        angle: 0,
                        strokeColor: "#374151",
                        backgroundColor: "transparent",
                        fillStyle: "hachure",
                        strokeWidth: 2,
                        strokeStyle: "solid",
                        roughness: 1,
                        opacity: 100,
                        groupIds: [],
                        seed: 23456,
                        frameId: null,
                        roundness: null,
                        boundElements: null,
                        updated: 1,
                        link: null,
                        locked: false,
                        points: [[0, 0], [100, 0]],
                        lastCommittedPoint: null,
                        startBinding: null,
                        endBinding: null,
                        startArrowhead: null,
                        endArrowhead: "arrow"
                    }
                ],
                appState: {
                    viewBackgroundColor: "#ffffff",
                    currentItemStrokeColor: "#000000",
                    currentItemBackgroundColor: "transparent",
                    currentItemFillStyle: "solid",
                    currentItemStrokeWidth: 2,
                    currentItemStrokeStyle: "solid",
                    currentItemRoughness: 1,
                    currentItemOpacity: 100,
                    currentItemFontFamily: 1,
                    currentItemFontSize: 20,
                    currentItemTextAlign: "left",
                    currentItemStartArrowhead: null,
                    currentItemEndArrowhead: "arrow",
                    zoom: { value: 1 },
                    scrollX: 0,
                    scrollY: 0,
                    gridMode: false
                },
                files: {},
                scrollToContent: false
            },

            flowchart: {
                elements: [
                    {
                        id: "start",
                        type: "rectangle",
                        x: 100,
                        y: 50,
                        width: 160,
                        height: 60,
                        angle: 0,
                        strokeColor: "#16a34a",
                        backgroundColor: "#bbf7d0",
                        fillStyle: "solid",
                        strokeWidth: 2,
                        strokeStyle: "solid",
                        roughness: 1,
                        opacity: 100,
                        groupIds: [],
                        seed: 1001,
                        frameId: null,
                        roundness: { type: 3, value: 16 },
                        boundElements: null,
                        updated: 1,
                        link: null,
                        locked: false
                    },
                    {
                        id: "start-text",
                        type: "text",
                        x: 180,
                        y: 65,
                        width: 40,
                        height: 30,
                        angle: 0,
                        strokeColor: "#16a34a",
                        backgroundColor: "transparent",
                        fillStyle: "solid",
                        strokeWidth: 2,
                        strokeStyle: "solid",
                        roughness: 1,
                        opacity: 100,
                        groupIds: [],
                        seed: 1002,
                        frameId: null,
                        roundness: null,
                        boundElements: null,
                        updated: 1,
                        link: null,
                        locked: false,
                        text: "å¼€å§‹",
                        fontSize: 20,
                        fontFamily: 1,
                        textAlign: "center",
                        verticalAlign: "middle",
                        containerId: null,
                        originalText: "å¼€å§‹",
                        lineHeight: 1.25
                    },
                    {
                        id: "process1",
                        type: "rectangle",
                        x: 100,
                        y: 170,
                        width: 160,
                        height: 80,
                        angle: 0,
                        strokeColor: "#2563eb",
                        backgroundColor: "#bfdbfe",
                        fillStyle: "solid",
                        strokeWidth: 2,
                        strokeStyle: "solid",
                        roughness: 1,
                        opacity: 100,
                        groupIds: [],
                        seed: 1003,
                        frameId: null,
                        roundness: null,
                        boundElements: null,
                        updated: 1,
                        link: null,
                        locked: false
                    },
                    {
                        id: "process1-text",
                        type: "text",
                        x: 120,
                        y: 185,
                        width: 120,
                        height: 50,
                        angle: 0,
                        strokeColor: "#2563eb",
                        backgroundColor: "transparent",
                        fillStyle: "solid",
                        strokeWidth: 2,
                        strokeStyle: "solid",
                        roughness: 1,
                        opacity: 100,
                        groupIds: [],
                        seed: 1004,
                        frameId: null,
                        roundness: null,
                        boundElements: null,
                        updated: 1,
                        link: null,
                        locked: false,
                        text: "æ•°æ®å¤„ç†",
                        fontSize: 16,
                        fontFamily: 1,
                        textAlign: "center",
                        verticalAlign: "middle",
                        containerId: null,
                        originalText: "æ•°æ®å¤„ç†",
                        lineHeight: 1.25
                    },
                    {
                        id: "arrow1",
                        type: "arrow",
                        x: 180,
                        y: 110,
                        width: 0,
                        height: 60,
                        angle: 0,
                        strokeColor: "#374151",
                        backgroundColor: "transparent",
                        fillStyle: "hachure",
                        strokeWidth: 2,
                        strokeStyle: "solid",
                        roughness: 1,
                        opacity: 100,
                        groupIds: [],
                        seed: 2001,
                        frameId: null,
                        roundness: null,
                        boundElements: null,
                        updated: 1,
                        link: null,
                        locked: false,
                        points: [[0, 0], [0, 60]],
                        lastCommittedPoint: null,
                        startBinding: null,
                        endBinding: null,
                        startArrowhead: null,
                        endArrowhead: "arrow"
                    }
                ],
                appState: {
                    viewBackgroundColor: "#f8fafc",
                    currentItemStrokeColor: "#000000",
                    currentItemBackgroundColor: "transparent",
                    currentItemFillStyle: "solid",
                    currentItemStrokeWidth: 2,
                    currentItemStrokeStyle: "solid",
                    currentItemRoughness: 1,
                    currentItemOpacity: 100,
                    currentItemFontFamily: 1,
                    currentItemFontSize: 20,
                    currentItemTextAlign: "left",
                    currentItemStartArrowhead: null,
                    currentItemEndArrowhead: "arrow",
                    zoom: { value: 1 },
                    scrollX: 0,
                    scrollY: 0,
                    gridMode: false
                },
                files: {},
                scrollToContent: false
            }
        };

        // ç­‰å¾…æ‰€æœ‰åº“åŠ è½½å®Œæˆ
        function initializeApp() {
            updateStatus('æ­£åœ¨æ£€æŸ¥åº“æ–‡ä»¶...', 'info');

            // æ£€æŸ¥ React æ˜¯å¦åŠ è½½
            if (typeof React === 'undefined') {
                updateStatus('âŒ React åº“æœªåŠ è½½', 'error');
                console.error('React åº“æœªåŠ è½½');
                return;
            }

            // æ£€æŸ¥ ReactDOM æ˜¯å¦åŠ è½½
            if (typeof ReactDOM === 'undefined') {
                updateStatus('âŒ ReactDOM åº“æœªåŠ è½½', 'error');
                console.error('ReactDOM åº“æœªåŠ è½½');
                return;
            }

            // æ£€æŸ¥ Excalidraw æ˜¯å¦åŠ è½½
            if (typeof ExcalidrawLib === 'undefined') {
                updateStatus('âŒ Excalidraw åº“æœªåŠ è½½', 'error');
                console.error('Excalidraw åº“æœªåŠ è½½');
                return;
            }

            updateStatus('âœ… æ‰€æœ‰åº“åŠ è½½æˆåŠŸï¼Œæ­£åœ¨åˆå§‹åŒ–...', 'success');
            console.log('React:', React);
            console.log('ReactDOM:', ReactDOM);
            console.log('ExcalidrawLib:', ExcalidrawLib);

            // åˆå§‹åŒ– Excalidraw
            setTimeout(() => {
                try {
                    const App = () => {
                        const [excalidrawAPI, setExcalidrawAPI] = React.useState(null);

                        React.useEffect(() => {
                            if (excalidrawAPI) {
                                window.excalidrawAPI = excalidrawAPI;
                                console.log('Excalidraw API åˆå§‹åŒ–å®Œæˆ');
                                updateStatus('âœ… Excalidraw åˆå§‹åŒ–æˆåŠŸ', 'success');
                            }
                        }, [excalidrawAPI]);

                        return React.createElement(ExcalidrawLib.Excalidraw, {
                            initialData: templates.simple,
                            onChange: (elements, state) => {
                                currentData = {
                                    elements: elements || [],
                                    appState: state || {},
                                    files: {},
                                    scrollToContent: false
                                };
                            },
                            onPointerUpdate: () => {},
                            viewModeEnabled: false,
                            zenModeEnabled: false,
                            gridModeEnabled: false,
                            excalidrawRef: (api) => setExcalidrawAPI(api)
                        });
                    };

                    // æ¸²æŸ“ React åº”ç”¨
                    const container = document.getElementById('excalidraw');
                    ReactDOM.render(React.createElement(App), container);

                    // éšè—åŠ è½½ä¿¡æ¯
                    const loadingInfo = document.getElementById('loading-info');
                    if (loadingInfo) {
                        loadingInfo.style.display = 'none';
                    }

                } catch (error) {
                    console.error('Excalidraw åˆå§‹åŒ–å¤±è´¥:', error);
                    updateStatus('âŒ Excalidraw åˆå§‹åŒ–å¤±è´¥: ' + error.message, 'error');
                }
            }, 500);
        }

        // æ˜¾ç¤ºçŠ¶æ€ä¿¡æ¯
        function updateStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = 'status ' + type;
            status.style.display = 'block';

            if (type === 'success') {
                setTimeout(() => {
                    status.style.display = 'none';
                }, 3000);
            }
        }

        // åŠ è½½æ¨¡æ¿
        function loadTemplate(templateName) {
            if (!templates[templateName]) {
                updateStatus('æ¨¡æ¿ä¸å­˜åœ¨', 'error');
                return;
            }

            currentData = templates[templateName];
            const jsonInput = document.getElementById('jsonInput');
            jsonInput.value = JSON.stringify(currentData, null, 2);

            // å¦‚æœ Excalidraw API å¯ç”¨ï¼Œæ›´æ–°åœºæ™¯
            if (window.excalidrawAPI) {
                window.excalidrawAPI.updateScene(currentData);
            }

            updateStatus(`å·²åŠ è½½æ¨¡æ¿: ${templateName}`, 'success');
        }

        // æ¸²æŸ“ Excalidraw
        function renderExcalidraw() {
            const jsonInput = document.getElementById('jsonInput');
            try {
                const data = JSON.parse(jsonInput.value);
                currentData = data;

                if (window.excalidrawAPI) {
                    window.excalidrawAPI.updateScene(data);
                    updateStatus('æ¸²æŸ“æˆåŠŸ', 'success');
                } else {
                    updateStatus('Excalidraw API æœªå°±ç»ª', 'error');
                }
            } catch (error) {
                updateStatus('JSON è§£æé”™è¯¯: ' + error.message, 'error');
            }
        }

        // å¯¼å‡ºä¸º PNG
        async function exportAsPNG() {
            if (!window.excalidrawAPI) {
                updateStatus('Excalidraw API æœªå°±ç»ª', 'error');
                return;
            }

            try {
                const blob = await window.excalidrawAPI.exportPng();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'excalidraw-export.png';
                a.click();
                URL.revokeObjectURL(url);
                updateStatus('PNG å¯¼å‡ºæˆåŠŸ', 'success');
            } catch (error) {
                updateStatus('å¯¼å‡ºå¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ¸…ç©ºç”»å¸ƒ
        function clearCanvas() {
            if (window.excalidrawAPI) {
                window.excalidrawAPI.resetScene();
                document.getElementById('jsonInput').value = '';
                currentData = null;
                updateStatus('ç”»å¸ƒå·²æ¸…ç©º', 'success');
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', function() {
            setTimeout(initializeApp, 1000);
        });
    </script>
</body>
</html>